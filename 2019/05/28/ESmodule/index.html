<!DOCTYPE html>
<html>
<head hexo-theme='https://volantis.js.org/#2.6.6'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
    <title>ESmodule - Secret Garden</title>
  
    <meta name="keywords" content="ESmodule">
  
  
    <meta name="description" content="ESmodule的标准化完成一定会掀起波澜~">
  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13/css/all.min.css">
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
  

  

  <!-- import link -->
  

  
  
    
<link rel="stylesheet" href="/css/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>
<header class="l_header shadow blur">
  <div class='container'>
  <div class='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h'>
        <li><a class="s-comment fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
          
          
          
            VOLANTIS <b><sup style='color:#3AA757'>2.6.6</sup></b>
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h'>
          
          
          
            
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="Search..." />
        </form>
      </div>

			<ul class='switcher nav-list-h'>
				
					<li><a class="s-search fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li>
          <a class="s-menu fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>
		</div>
	</div>
  </div>
</header>

<script>setLoadingBarProgress(40);</script>



  <div class="l_body nocover">
    <div class='body-wrapper'>
      

<div class='l_main'>
  

  
    <article id="post" class="post white-box reveal shadow article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h1 class="title">
    <a href="/2019/05/28/ESmodule/">
      ESmodule
    </a>
  </h1>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a href="https://tsunamigg.github.io/" rel="nofollow">
    <img src="https://avatars2.githubusercontent.com/u/37109219?s=460&u=72c6da1fb1e7512a0f73dd255dd2b85998682a99&v=4">
    <p>tsunami</p>
  </a>
</div>

            
          
            
              

            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：May 28, 2019</p>
  </a>
</div>

            
          
            
              
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard fa-fw" aria-hidden="true"></i>
      <p>5.7k words</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half fa-fw" aria-hidden="true"></i>
      <p>19 min</p>
    </a>
  </div>


            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <p>ESmodule的标准化完成一定会掀起波澜~</p>
<a id="more"></a>
<h2 id="图说-ES-Modules（转载译文）"><a href="#图说-ES-Modules（转载译文）" class="headerlink" title="图说 ES Modules（转载译文）"></a>图说 ES Modules（转载译文）</h2><p>原文：<a href="https://hacks.mozilla.org/2018/03/es-modules-a-cartoon-deep-dive/" target="_blank" rel="noopener">ES modules: A cartoon deep-dive, Lin Clark</a></p>
<p>ES modules（ESM） 是 JavaScript 官方的标准化模块系统。<br>然而，它在标准化的道路上已经花费了近 10 年的时间。</p>
<p>可喜的是，标准化之路马上就要完成了。等到 2018 年 5 月 Firefox 60 发布之后，所有的主流浏览器就都支持 ESM 了。同时，Node 模块工作小组也正在为 Node.js 添加 ESM 支持。<a href="https://www.youtube.com/watch?v=qR_b5gajwug" target="_blank" rel="noopener">为 WebAssembly 提供 ESM 集成</a>的工作也正在如火如荼的进行。</p>
<p>许多 JS 开发者都知道，对 ESM 的讨论从开始至今一直都没停过。但是很少有人真正理解 ESM 的工作原理。</p>
<p>今天，让我们来梳理梳理 ESM 到底解决了什么问题，以及它跟其他模块系统之间有什么区别。</p>
<h4 id="为何要模块化"><a href="#为何要模块化" class="headerlink" title="为何要模块化"></a>为何要模块化</h4><p>说到 JS 编程，其实说的就是<strong>如何管理变量</strong>。<br>编程的过程都是关于如何给变量赋值，要么直接赋值给变量，要么是把两个变量结合起来然后再把结果赋值给另一个变量</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/01_variables-500x178.png" alt="Code showing variables being manipulated"></p>
<p>因为大部分代码都是关于改变变量的，所以如何组织这些变量就直接影响了编码质量，以及维护它们的成本。</p>
<p>如果代码中仅有少量的变量，那么组织起来其实是很简单的。<br>JS 本身就提供了一种方式帮你组织变量，称为<strong>函数作用域</strong>。因为函数作用域的缘故，一个函数无法访问另一个函数中定义的变量。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/02_module_scope_01-500x292.png" alt="Two function scopes with one trying to reach into another but failing"></p>
<p>这种方式是很有效的。它使得我们在写一个函数的时候，只需要考虑当前函数，而不必担心其它函数可能会改变当前函数的变量。<br>不过，它也有不好的地方。它会让我们很难在不同函数之间<strong>共享变量</strong>。</p>
<p>如果我们想跟当前函数以外的函数共享变量要怎么办呢？一种通用的做法是把要共享的变量提升到上一层作用域，比如全局作用域。</p>
<p>在 jQuery 时代这种提升做法相当普遍。在我们加载任何 jQuery 插件之前，我们必须确保 jQuery 已经存在于全局作用域。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/02_module_scope_02-500x450.png" alt="Two function scopes in a global, with one putting jQuery into the global"></p>
<p>这种做法也确实行之有效，但是也带来了令人烦恼的影响。<br>首先，所有的 <code>&lt;script&gt;</code> 必须<strong>以正确的顺序排列</strong>，开发者必须非常谨慎地确保没有任何一个脚本排列错误。</p>
<p>如果排列错了，那么在运行过程中，应用将会抛出错误。当函数在全局作用域寻找 jQuery 变量时，如果没有找到，那么它将会抛出异常错误，并且停止继续运行。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/02_module_scope_03-500x450.png" alt="The top function scope has been removed and now the second function scope can’t find jQuery on the global"></p>
<p>这同时也使得代码的后期维护变得困难。<br>它会使得移除旧代码或者脚本标签变得充满不确定性。你根本不知道移除它会带来什么影响。<strong>代码之间的依赖是不透明的</strong>。任何函数都可能依赖全局作用域中的任何变量，以至于你也不知道哪个函数依赖哪个脚本。</p>
<p>其次，由于变量存在于全局作用域，所以<strong>任何代码都可以改变它</strong>。<br>恶意的代码可能会故意改变全局变量，从而让你的代码做出危险行为。又或者，代码可能不是恶意的，但是却无意地改变了你期望的变量。、</p>
<h4 id="模块化的作用"><a href="#模块化的作用" class="headerlink" title="模块化的作用"></a>模块化的作用</h4><p><strong>模块化为你提供了一种更好的方式来组织变量和函数</strong>。你可以把相关的变量和函数放在一起组成一个模块。</p>
<p>这种组织方式会把函数和变量放在<strong>模块作用域</strong>中。模块中的函数可以通过模块作用域来共享变量。</p>
<p>不过，与函数作用域不同的是，模块作用域还提供了一种暴露变量给其他模块使用的方式。模块可以明确地指定哪些变量、类或函数对外暴露。</p>
<p>对外暴露的过程称为<strong>导出</strong>。一旦导出，其他模块就可以明确地声称它们依赖这些导出的变量、类或者函数。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/02_module_scope_04-500x450.png" alt="Two module scopes, with one reaching into the other to grab an export"></p>
<p>因为这是一种明确的关系，所以你可以很简单地辨别哪些代码能移除，哪些不能移除。</p>
<p>拥有了在模块之间导出和导入变量的能力之后，你就可以把代码分割成更小的、可以独立运行地代码块了。然后，你就可以像搭乐高积木一样，基于这些代码块，创建所有不同类型的应用。</p>
<p>由于模块化是非常有用的，所以历史上曾经多次尝试为 JS 添加模块化的功能。不过截止到目前，真正得到广泛使用的只有两个模块系统。<br>一个是 Node.js 使用的 CommonJS （CJS）；另一个是 JS 规范的新模块系统 EcmaScript modules（ESM），Node.js 也正在添加对 ESM 的支持。</p>
<p>下面就让我们来深入理解下这个新的模块系统是如何工作的。</p>
<h4 id="ESM-原理"><a href="#ESM-原理" class="headerlink" title="ESM 原理"></a>ESM 原理</h4><p>当你在使用模块进行开发时，其实是在构建一张<strong>依赖关系图</strong>。不同模块之间的连线就代表了代码中的导入语句。</p>
<p>正是这些导入语句告诉浏览器或者 Node 该去加载哪些代码。<br>我们要做的是为依赖关系图指定一个<strong>入口文件</strong>。从这个入口文件开始，浏览器或者 Node 就会顺着导入语句找出所依赖的其他代码文件。</p>
<img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/04_import_graph-500x291.png" alt="A module with two dependencies. The top module is the entry. The other two are related using import statements"  />





<p>但是呢，浏览器并不能直接使用这些代码文件。它需要解析所有的文件，并把它们变成一种称为<strong>模块记录</strong>（Module Record）的数据结构。只有这样，它才知道代码文件中到底发生了什么。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/05_module_record-500x287.png" alt="A module record with various fields, including RequestedModules and ImportEntries"></p>
<p>解析之后，还需要把模块记录变成一个<strong>模块实例</strong>。模块实例会把<strong>代码和状态</strong>结合起来。</p>
<p>所谓代码，基本上是一组指令集合。它就像是制作某样东西的配方，指导你该如何制作。<br>但是它本身并不能让你完成制作。你还需要一些原料，这样才可以按照这些指令完成制作。</p>
<p>所谓状态，它就是原料。具体点，状态是变量在任何时候的真实值。<br>当然，变量实际上就是内存地址的别名，内存才是正在存储值的地方。</p>
<p>所以，可以看出，<strong>模块实例中代码和状态的结合，就是指令集和变量值的结合</strong>。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/06_module_instance-500x372.png" alt="A module instance combining code and state"></p>
<p>对于模块而言，我们真正需要的是模块实例。<br>模块加载会从入口文件开始，最终生成完整的模块实例关系图。</p>
<p>对于 ESM ，这个过程包含三个阶段：</p>
<ol>
<li><strong>构建</strong>：查找，下载，然后把所有文件解析成模块记录。</li>
<li><strong>实例化</strong>：为所有模块分配内存空间（此刻还没有填充值），然后依照导出、导入语句把模块指向对应的内存地址。这个过程称为<strong>链接</strong>（Linking）。</li>
<li><strong>运行</strong>：运行代码，从而把内存空间填充为真实值。</li>
</ol>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/07_3_phases-500x184.png" alt="The three phases. Construction goes from a single JS file to multiple module records. Instantiation links those records. Evaluation executes the code."></p>
<p>大家都说 ESM 是异步的。<br>因为它把整个过程分为了三个不同的阶段：加载、实例化和运行，并且这三个阶段是可以独立进行的。</p>
<p>这意味着，ESM 规范确实引入了一种异步方式，且这种异步方式在 CJS 中是没有的。<br>后面我们会详细说到为什么，然而在 CJS 中，一个模块及其依赖的加载、实例化和运行是一起顺序执行的，中间没有任何间断。</p>
<p>不过，这三个阶段本身是没必要异步化。它们可以同步执行，这取决于它是由谁来加载的。因为 ESM 标准并没有明确规范所有相关内容。实际上，这些工作分为两部分，并且分别是由不同的标准所规范的。</p>
<p>其中，<a href="https://tc39.github.io/ecma262/#sec-modules" target="_blank" rel="noopener">ESM 标准</a> 规范了如何把文件解析为模块记录，如何实例化和如何运行模块。但是它没有规范如何获取文件。</p>
<p>文件是由<strong>加载器</strong>来提取的，而加载器由另一个不同的标准所规范。对于浏览器来说，这个标准就是 <a href="https://html.spec.whatwg.org/#fetch-a-module-script-tree" target="_blank" rel="noopener">HTML</a>。但是你还可以根据所使用的平台使用不同的加载器。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/07_loader_vs_es-500x286.png" alt="Two cartoon figures. One represents the spec that says how to load modules (i.e., the HTML spec). The other represents the ES module spec."></p>
<p>加载器也同时控制着如何加载模块。它会调用 ESM 的方法，包括 <code>ParseModule</code>、<code>Module.Instantiate</code> 和 <code>Module.Evaluate</code> 。它就像是控制着 JS 引擎的木偶。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/08_loader_as_puppeteer-500x330.png" alt="The loader figure acting as a puppeteer to the ES module spec figure."></p>
<p>下面我们将更加详细地说明每一步。</p>
<h5 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h5><p>对于每个模块，在构建阶段会做三个处理：</p>
<ol>
<li>确定要从哪里下载包含该模块的文件，也称为模块定位（Module Resolution）</li>
<li>提取文件，通过从 URL 下载或者从文件系统加载</li>
<li>解析文件为模块记录</li>
</ol>
<h6 id="1-下载模块"><a href="#1-下载模块" class="headerlink" title="1.下载模块"></a>1.下载模块</h6><p>加载器负责定位文件并且提取。首先，它需要找到入口文件。在 HTML 中，你可以通过 <code>&lt;script&gt;</code> 标签来告诉加载器。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/08_script_entry-500x188.png" alt="A script tag with the type=module attribute and a src URL. The src URL has a file coming from it which is the entry"></p>
<p>但是，加载器要如何定位 <code>main.js</code> 直接依赖的模块呢？<br>这个时候导入语句就派上用场了。导入语句中有一部分称为<strong>模块定位符</strong>（Module Specifier），它会告诉加载器去哪定位模块。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/09_module_specifier-500x105.png" alt="An import statement with the URL at the end labeled as the module specifier"></p>
<p>对于模块定位符，有一点要注意的是：它们在浏览器和 Node 中会有不同的处理。每个平台都有自己的一套方式来解析模块定位符。这些方式称为<strong>模块定位算法</strong>，不同的平台会使用不同的模块定位算法。<br>当前，一些在 Node 中能工作模块定位符并不能在浏览器中工作，但是已经有一项工作<a href="https://github.com/domenic/package-name-maps" target="_blank" rel="noopener">正在解决这个问题</a>。</p>
<p>在这个问题被解决之前，浏览器只接受 URL 作为模块定位符。<br>它们会从 URL 加载模块文件。但是，这并不是在整个关系图上同时发生的。因为在解析完这个模块之前，你根本不知道它依赖哪些模块。而且在它下载完成之前，你也无法解析它。</p>
<p>这就意味着，我们必须一层层遍历依赖树，先解析文件，然后找出依赖，最后又定位并加载这些依赖，如此往复。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/10_construction-500x302.png" alt="A diagram that shows one file being fetched and then parsed, and then two more files being fetched and then parsed"></p>
<p>如果主线程正在等待这些模块文件下载完成，许多其他任务将会堆积在任务队列中，造成阻塞。这是因为在浏览器中，下载会耗费大量的时间。</p>
<p><img src="https://segmentfault.com/img/bV78AB?w=500&h=270" alt="11_latency-500x270.png"></p>
<p>而阻塞主线程会使得应用变得卡顿，影响用户体验。这是 ESM 标准把算法分成多个阶段的原因之一。将构建划分为一个独立阶段后，浏览器可以在进入同步的实例化过程之前下载文件然后理解模块关系图。</p>
<p>ESM 和 CJS 之间最主要的区别之一就是，ESM 把算法化为为多个阶段。</p>
<p>CJS 使用不同的算法是因为它从文件系统加载文件，这耗费的时间远远小于从网络上下载。因此 Node 在加载文件的时候可以阻塞主线程，而不造成太大影响。而且既然文件已经加载完成了，那么它就可以直接进行实例化和运行。所以在 CJS 中实例化和运行并不是两个相互独立的阶段。<br>这也意味着，你可以在返回模块实例之前，顺着整颗依赖树去逐一加载、实例化和运行每一个依赖。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/12_cjs_require-500x298.png" alt="A diagram showing a Node module evaluating up to a require statement, and then Node going to synchronously load and evaluate the module and any of its dependencies"></p>
<p>CJS 的方式对 ESM 也有一些启发，这个后面会解释。<br>其中一个就是，在 Node 的 CJS 中，你可以在模块定位符中使用变量。因为已经执行了 <code>require</code> 之前的代码，所以模块定位符中的变量此刻是有值的，这样就可以进行模块定位的处理了。</p>
<p>但是对于 ESM，在运行任何代码之前，你首先需要建立整个模块依赖的关系图。也就是说，<strong>建立关系图时变量是还没有值的</strong>，因为代码都还没运行。</p>
<img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/13_static_import-500x146.png" alt="A require statement which uses a variable is fine. An import statement that uses a variable is not."  />

<p>不过呢，有时候我们确实需要在模块定位符中使用变量。比如，你可能需要根据当前的状况加载不同的依赖。</p>
<p>为了在 ESM 中实现这种方式，人们已经提出了一个<strong>动态导入</strong>提案。该提案允许你可以使用类似 <code>import(\</code>${path}/foo.js<code>)</code>的导入语句。</p>
<p>这种方式实际上是把使用 <code>import()</code> 加载的文件当成了一个入口文件。动态导入的模块会开启一个全新的独立依赖关系树。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/14dynamic_import_graph-500x389.png" alt="Two module graphs with a dependency between them, labeled with a dynamic import statement"></p>
<p>不过有一点要注意的是，这两棵依赖关系树共有的模块会共享同一个模块实例。这是因为加载器会缓存模块实例。在特定的全局作用域中，每个模块只会有一个与之对应的模块实例。</p>
<p>这种方式有助于提高 JS 引擎的性能。例如，一个模块文件只会被下载一次，即使有多个模块依赖它。这也是缓存模块的原因之一，后面说到运行的时候会介绍另一个原因。</p>
<p>加载器使用<strong>模块映射</strong>（Module Map）来管理缓存。每个全局作用域都在一个单独的模块映射中跟踪其模块。</p>
<p>当加载器要从一个 URL 加载文件时，它会把 URL 记录到模块映射中，并把它标记为正在下载的文件。然后它会发出这个文件请求并继续开始获取下一个文件。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/15_module_map-500x170.png" alt="The loader figure filling in a Module Map chart, with the URL of the main module on the left and the word fetching being filled in on the right"></p>
<p>当其他模块也依赖这个文件的时候会发生什么呢？加载器会查找模块映射中的每一个 URL 。如果发现 URL 的状态为正在下载，则会跳过该 URL ，然后开始下一个依赖的处理。</p>
<p>不过，模块映射的作用并不仅仅是记录哪些文件已经下载。下面我们将会看到，模块映射也可以作为模块的缓存。</p>
<h6 id="2-解析模块"><a href="#2-解析模块" class="headerlink" title="2.解析模块"></a>2.解析模块</h6><p>至此，我们已经拿到了模块文件，我们需要把它解析为模块记录。<br>这有助于浏览器理解模块的不同部分。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/25_file_to_module_record-500x199.png" alt="Diagram showing main.js file being parsed into a module record"></p>
<p>一旦模块记录创建完成，它就会被记录在模块映射中。所以，后续任何时候再次请求这个模块时，加载器就可以直接从模块映射中获取该模块。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/25_module_map-500x239.png" alt="The “fetching” placeholders in the module map chart being filled in with module records"></p>
<p>解析过程中有一个看似微不足道的细节，但是实际造成的影响却很大。那就是所有的模块都按照<strong>严格模式</strong>来解析的。<br>也还有其他的小细节，比如，关键字 <code>await</code> 在模块的最顶层是保留字， <code>this</code> 的值为 <code>undefinded</code>。</p>
<p>这种不同的解析方式称为<strong>解析目标</strong>（Parse Goal）。如果按照不同的解析目标来解析相同的文件，会得到不同的结果。因此，在解析文件之前，必须清楚地知道所解析的文件类型是什么，不管它是不是一个模块文件。</p>
<p>在浏览器中，知道文件类型是很简单的。只需要在 <code>&lt;script&gt;</code> 脚本中添加 <code>type=&quot;module&quot;</code> 属性即可。这告诉浏览器这个文件需要被解析为一个模块。而且，因为只有模块才能被导入，所以浏览器以此推测所有的导入也都是模块文件。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/26_parse_goal-500x311.png" alt="The loader determining that main.js is a module because the type attribute on the script tag says so, and counter.js must be a module because it’s imported"></p>
<p>不过在 Node 中，我们并不使用 HTML 标签，所以也没办法通过 <code>type</code> 属性来辨别。社区提出一种解决办法是使用 <code>.mjs</code> 拓展名。使用该拓展名会告诉 Node 说“这是个模块文件”。你会看到大家正在讨论把这个作为解析目标。不过讨论仍在继续，所以目前仍不明确 Node 社区最终会采用哪种方式。</p>
<p>无论最终使用哪种方式，加载器都会决定是否把一个文件作为模块来解析。如果是模块，而且包含导入语句，那它会重新开始处理直至所有的文件都已提取和解析。</p>
<p>到这里，构建阶段差不多就完成了。在加载过程处理完成后，你已经从最开始只有一个入口文件，到现在得到了一堆模块记录。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/27_construction-500x406.png" alt="A JS file on the left, with 3 parsed module records on the right as a result of the construction phase"></p>
<p>下一步会实例化这些模块并且把所有的实例链接起来。</p>
<h5 id="实例化"><a href="#实例化" class="headerlink" title="实例化"></a>实例化</h5><p>正如前文所述，一个模块实例结合了代码和状态。状态存储在内存中，所以实例化的过程就是把所有值写入内存的过程。</p>
<p>首先，JS 引擎会创建一个<strong>模块环境记录</strong>（Module Environment Record）。它管理着模块记录的所有变量。然后，引擎会找出多有导出在内存中的地址。模块环境记录会跟踪每个导出对应于哪个内存地址。</p>
<p>这些内存地址此时还没有值，只有等到运行后它们才会被填充上实际值。有一点要注意，所有导出的函数声明都在这个阶段初始化，这会使得后面的运行阶段变得更加简单。</p>
<p>为了实例化模块关系图，引擎会采用<strong>深度优先的后序遍历方式</strong>。<br>即，它会顺着关系图到达最底端没有任何依赖的模块，然后设置它们的导出。</p>
<p><img src="https://hacks.mozilla.org/files/2018/03/30_live_bindings_04-500x206.png" alt="30_live_bindings_01.png"></p>
<p>最终，引擎会把模块下的所有依赖导出链接到当前模块。然后回到上一层把模块的导入链接起来。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/30_live_bindings_02-500x206.png" alt="Same diagram as above, but with the module environment record for main.js now having its imports linked up to the exports from the other two modules."></p>
<p>这个过程跟 CJS 是不同的。在 CJS 中，整个导出对象在导出时都是<strong>值拷贝</strong>。<br>即，所有的导出值都是拷贝值，而不是引用。<br>所以，如果导出模块内导出的值改变了，导入模块中导入的值也不会改变。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/31_cjs_variable-500x113.png" alt="Memory in the middle with an exporting common JS module pointing to one memory location, then the value being copied to another and the importing JS module pointing to the new location"></p>
<p>相反，ESM 则使用称为<strong>实时绑定</strong>（Live Binding）的方式。导出和导入的模块都指向相同的内存地址（即<strong>值引用</strong>）。所以，当导出模块内导出的值改变后，导入模块中的值也实时改变了。</p>
<p>模块导出的值在任何时候都可以能发生改变，但是导入模块却不能改变它所导入的值，因为它是<strong>只读</strong>的。<br>举例来说，如果一个模块导入了一个对象，那么它只能改变该对象的属性，而不能改变对象本身。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/30_live_bindings_04-500x206.png" alt="The exporting module changing the value in memory. The importing module also tries but fails."></p>
<p>ESM 采用这种实时绑定的原因是，引擎可以在不运行任何模块代码的情况下完成链接。后面会解释到，这对解决运行阶段的循环依赖问题也是有帮助的。</p>
<p>实例化阶段完成后，我们得到了所有模块实例，以及已完成链接的导入、导出值。</p>
<p>现在我们可以开始运行代码并且往内存空间内填充值了。</p>
<h5 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h5><p>最后一步是往已申请好的内存空间中填入真实值。JS 引擎通过运行顶层代码（函数外的代码）来完成填充。</p>
<p>除了填充值以外，运行代码也会引发一些副作用（Side Effect）。例如，一个模块可能会向服务器发起请求。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/40_top_level_code-500x146.png" alt="A module will code outside of functions, labeled top level code"></p>
<p>因为这些潜在副作用的存在，所以<strong>模块代码只能运行一次</strong>。<br>前面我们看到，实例化阶段中发生的链接可以多次进行，并且每次的结果都一样。但是，如果运行阶段进行多次的话，则可能会每次都得到不一样的结果。</p>
<p>这正是为什么会使用模块映射的原因之一。模块映射会以 URL 为索引来缓存模块，以确保每个模块<strong>只有一个</strong>模块记录。这保证了每个模块只会运行一次。跟实例化一样，运行阶段也采用深度优先的后序遍历方式。</p>
<p>那对于前面谈到的循环依赖会怎么处理呢？</p>
<p>循环依赖会使得依赖关系图中出现一个依赖环，即你依赖我，我也依赖你。通常来说，这个环会非常大。不过，为了解释好这个问题，这里我们举例一个简单的循环依赖。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/41_cjs_cycle-500x224.png" alt="A complex module graph with a 4 module cycle on the left. A simple 2 module cycle on the right."></p>
<p><code>counter</code> 模块会试图去访问导出对象的 <code>message</code> 。不过，由于 <code>main</code> 模块中还没运行到 <code>message</code> 处，所以此时得到的 <code>message</code> 为 <code>undefined</code>。JS 引擎会为本地变量分配空间并把值设为 <code>undefined</code> 。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/42_cjs_variable_2-500x113.png" alt="Memory in the middle with no connection between main.js and memory, but an importing link from counter.js to a memory location which has undefined"></p>
<p>运行阶段继续往下执行，直到 <code>counter</code> 模块顶层代码的末尾处。我们想知道，当 <code>counter</code> 模块运行结束后，<code>message</code> 是否会得到真实值，所以我们设置了一个超时定时器。之后运行阶段便返回到 <code>main.js</code> 中。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/43_cjs_cycle-500x224.png" alt="counter.js returning control to main.js, which finishes evaluating"></p>
<p>这时，<code>message</code> 将会被初始化并添加到内存中。但是这个 <code>message</code> 与 <code>counter</code> 模块中的 <code>message</code> 之间并没有任何关联关系，所以 <code>counter</code> 模块中的 <code>message</code> 仍然为 <code>undefined</code>。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2018/03/44_cjs_variable_2-500x216.png" alt="main.js getting its export connection to memory and filling in the correct value, but counter.js still pointing to the other memory location with undefined in it"></p>
<p>如果导出值采用的是实时绑定方式，那么 <code>counter</code> 模块最终会得到真实的 <code>message</code> 值。当超时定时器开始计时时，<code>main.js</code> 的运行就已经完成并设置了 <code>message</code> 值。</p>
<p>支持循环依赖是 ESM 设计之初就考虑到的一大原因。也正是这种分段设计使其成为可能。</p>
<h4 id="ESM-的当前状态"><a href="#ESM-的当前状态" class="headerlink" title="ESM 的当前状态"></a>ESM 的当前状态</h4><p>等到 2018 年 5 月 Firefox 60 发布后，所有的主流浏览器就都默认支持 ESM 了。Node 也正在添加 ESM 支持，为此还成立了<a href="https://github.com/nodejs/modules" target="_blank" rel="noopener">工作小组</a>来专门研究 CJS 和 ESM 之间的兼容性问题。</p>
<p>所以，在未来你可以直接在 <code>&lt;script&gt;</code> 标签中使用 <code>type=&quot;module&quot;</code>，并且在代码中使用 <code>import</code> 和 <code>export</code> 。<br>同时，更多的模块功能也正在研究中。<br>比如<a href="https://github.com/tc39/proposal-dynamic-import" target="_blank" rel="noopener">动态导入提案</a>已经处于 Stage 3 状态；<a href="https://github.com/tc39/proposal-import-meta" target="_blank" rel="noopener"><code>import.meta</code></a>也被提出以便 Node.js 对 ESM 的支持；<a href="https://github.com/domenic/package-name-maps" target="_blank" rel="noopener">模块定位提案</a> 也致力于解决浏览器和 Node.js 之间的差异。</p>
<p>相信在不久的未来，跟模块一起玩耍将会变成一件更加愉快的事！</p>

          
            <div class='article_footer'>
              
                
  
    
    



  

  
    
    



  

  
    
    

<section class="widget copyright  desktop mobile">
  <div class='content'>
    
      <blockquote>
        
          
            <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>

          
        
          
            <p>本文永久链接是：<a href=https://tsunamigg.github.io/2019/05/28/ESmodule/>https://tsunamigg.github.io/2019/05/28/ESmodule/</a></p>
          
        
      </blockquote>
    
  </div>
</section>

  

  
    
    

<section class="widget qrcode  desktop mobile">
  

  <div class='content article-entry'>
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
  </div>
</section>

  


              
            </div>
          
        </div>
        
          


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-05-28T22:21:05+08:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：May 28, 2020</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/ESmodule/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>ESmodule</p></a></div>


        
      
        
          

        
      
        
      
    </div>
  </section>


        
        
          <div class="prev-next">
            
              <a class='prev' href='/2019/06/22/http-cache/'>
                <p class='title'><i class="fas fa-chevron-left" aria-hidden="true"></i>初识`http`缓存</p>
                <p class='content'>不打不相识之http缓存


初识http缓存近日，发现我打包的js代码上传到服务器后，并没有更新。想到用ng做了代理，可能是ng缓存的问题，就查资料学习了一下http（1.1）缓存的东西。

...</p>
              </a>
            
            
              <a class='next' href='/2019/05/19/Event%20loop/'>
                <p class='title'>Event loop<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
                <p class='content'>Event loop的粗浅认识


事件轮询js是单线程的。其事件轮询由：同步任务，异步任务，macrotask（宏任务），microtask （微任务）组成。其执行过程如下：

同步任务： 主...</p>
              </a>
            
          </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box reveal comments shadow">
    <section class="article typo">
      <p ct><i class='fas fa-comments'></i> 评论</p>
      
      
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-cog fa-spin fa-fw fa-2x"></i>
          </div>
        </section>
      
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'ESmodule',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
  

  
    
    


  <section class="widget toc-wrapper shadow blur desktop mobile">
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#图说-ES-Modules（转载译文）"><span class="toc-text">图说 ES Modules（转载译文）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#为何要模块化"><span class="toc-text">为何要模块化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模块化的作用"><span class="toc-text">模块化的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ESM-原理"><span class="toc-text">ESM 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#构建"><span class="toc-text">构建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#实例化"><span class="toc-text">实例化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#运行"><span class="toc-text">运行</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ESM-的当前状态"><span class="toc-text">ESM 的当前状态</span></a></li></ol></li></ol></li></ol>
    </div>
  </section>


  


</aside>


  
  <footer class="clearfix">
    <br><br>
    
      
        <div class="aplayer-container">
          

  
    <meting-js
      theme='#1BCDFC'
      autoplay='false'
      volume='0.7'
      loop='all'
      order='list'
      fixed='false'
      list-max-height='340px'
      server='netease'
      type='playlist'
      id='3175833810'
      list-folded='true'>
    </meting-js>
  


        </div>
      
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="mailto:ganchao1996@gmai.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://github.com/tsunamiGG"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://music.163.com/#/user/home?id=63035382"
                class="social fas fa-headphones-alt flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        <div><p>Blog content follows the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) License</a></p>
</div>
      
    
      
        Use
        <a href="https://volantis.js.org/" target="_blank" class="codename">Volantis</a>
        as theme, total visits
          <span id="busuanzi_value_site_pv"><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span>
          times
        
      
    
      
        <div class='copyright'>
        <p><a href="https://tsunamigg.github.io/">Copyright © 2017-2020 tsunamigg</a></p>

        </div>
      
    
  </footer>

<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js"></script>


  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>


  <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.6/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      ScrollReveal().reveal('.l_main .reveal', {
        distance: '8px',
        duration: '800',
        interval: '100',
        scale: '1'
      });
    });
  </script>


  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script defer src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>



  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('.cover') {
          $('.cover').backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        }
      });
    </script>
  



  
    
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js"></script>

  
    
<script src="https://cdn.jsdelivr.net/npm/meting@2.0/dist/Meting.min.js"></script>

  









  
    
<script src="https://cdn.jsdelivr.net/npm/valine@1.4/dist/Valine.min.js"></script>

  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var meta = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var REQUIRED_FIELDS = ['nick','mail','link'];
  var requiredFields = 'nick,mail'.split(',').filter(function(item){
    return REQUIRED_FIELDS.indexOf(item) > -1
  });
  var valine = new Valine();
  function emoji(path, idx, ext) {
      return path + "/" + path + "-" + idx + "." + ext;
  }
  var emojiMaps = {};
  for (var i = 1; i <= 54; i++) {
    emojiMaps['tieba-' + i] = emoji('tieba', i, 'png');
  }
  for (var i = 1; i <= 101; i++) {
    emojiMaps['qq-' + i] = emoji('qq', i, 'gif');
  }
  for (var i = 1; i <= 116; i++) {
    emojiMaps['aru-' + i] = emoji('aru', i, 'gif');
  }
  for (var i = 1; i <= 125; i++) {
    emojiMaps['twemoji-' + i] = emoji('twemoji', i, 'png');
  }
  for (var i = 1; i <= 4; i++) {
    emojiMaps['weibo-' + i] = emoji('weibo', i, 'png');
  }
  valine.init({
    el: '#valine_container',
    meta: meta,
    
    appId: "dogUA2FSKGTo029M1SEwGROT-MdYXbMMI",
    appKey: "u0NdtQ8nvHoMdJPSYqm1LRxE",
    placeholder: "快来评论吧~",
    pageSize:'10',
    avatar:'robohash',
    lang:'zh-cn',
    visitor: 'true',
    highlight: 'true',
    mathJax: 'false',
    enableQQ: 'true',
    requiredFields: requiredFields,
    emojiCDN: 'https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/emoji/valine/',
    emojiMaps: emojiMaps
  })
  </script>





  
<script src="/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.6.5/js/search.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js"></script>






<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-check-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-check-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-times-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-times-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>




<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  function pjax_fancybox() {
    $(".article-entry").find("img").not('.inline').not('a img').each(function () { //渲染 fancybox
      var element = document.createElement("a"); // a 标签
      $(element).attr("pjax-fancybox", "");  // 过滤 pjax
      $(element).attr("href", $(this).attr("src"));
      if ($(this).attr("data-original")) {
        $(element).attr("href", $(this).attr("data-original"));
      }
      $(element).attr("data-fancybox", "images");
      var caption = "";   // 描述信息
      if ($(this).attr('alt')) {  // 标准 markdown 描述信息
        $(element).attr('data-caption', $(this).attr('alt'));
        caption = $(this).attr('alt');
      }
      var div = document.createElement("div");
      $(div).addClass("fancybox");
      $(this).wrap(div); // 最外层套 div ，其实主要作用还是 class 样式
      var span = document.createElement("span");
      $(span).addClass("image-caption");
      $(span).text(caption); // 加描述
      $(this).after(span);  // 再套一层描述
      $(this).wrap(element);  // 最后套 a 标签
    })
    $(".article-entry").find("img").fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
      closeClick: true,
      helpers: {
        overlay: {closeClick: true}
      },
      buttons: [
        "zoom",
        "close"
      ]
    });
  };
  $(function () {
    pjax_fancybox();
  });
</script>




  <script>setLoadingBarProgress(100);</script>
</body>
</html>
